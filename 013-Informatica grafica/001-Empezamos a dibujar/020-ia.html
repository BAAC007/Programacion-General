<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Canvas Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      :root{
        /* Paleta minimalista y elegante */
        --bg:#f8f9fa;
        --surface:#ffffff;
        --surface-alt:#f5f7fa;
        --border:#e0e3e8;
        --border-light:#f0f2f5;
        --text:#1a1d22;
        --text-muted:#6c757d;
        --text-light:#868e96;
        --primary:#4361ee;
        --primary-light:#4895ef;
        --primary-dark:#3a56d4;
        --success:#2ecc71;
        --warning:#f39c12;
        --danger:#e74c3c;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
        --shadow-lg: 0 8px 24px rgba(0,0,0,0.1);
        --radius-sm: 6px;
        --radius-md: 10px;
        --radius-lg: 14px;
        --radius-xl: 18px;
        --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      }

      *{box-sizing:border-box; margin:0; padding:0}
      html,body{height:100%}
      body{
        margin:0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        color: var(--text);
        overflow:hidden;
        letter-spacing: -0.02em;
      }

      /* App layout - más aireado */
      .app{
        height:100%;
        display:grid;
        grid-template-rows: 56px 1fr 32px;
        grid-template-columns: 260px 1fr 280px;
        grid-template-areas:
          "top top top"
          "left center right"
          "status status status";
        gap:16px;
        padding:16px;
        max-width: 100vw;
      }

      /* Top bar - más limpio */
      .topbar{
        grid-area:top;
        background:var(--surface);
        border-radius:var(--radius-lg);
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:0 20px;
        box-shadow: var(--shadow-md);
        border:1px solid var(--border);
      }
      
      .brand{
        display:flex;
        align-items:center;
        gap:12px;
        font-weight:600;
        font-size:18px;
        color:var(--text);
      }
      
      .dot{
        width:10px;
        height:10px;
        border-radius:50%;
        background:var(--primary);
        box-shadow:0 0 0 3px rgba(67, 97, 238, 0.15);
      }
      
      .top-actions{
        display:flex;
        gap:12px;
        align-items:center;
      }
      
      .btn{
        background:var(--surface);
        border:1px solid var(--border);
        color:var(--text);
        border-radius:var(--radius-md);
        padding:10px 16px;
        cursor:pointer;
        font-size:14px;
        font-weight:500;
        display:inline-flex;
        align-items:center;
        gap:8px;
        transition: var(--transition);
        user-select:none;
        height:40px;
      }
      
      .btn:hover{
        background:var(--surface-alt);
        border-color:var(--border-light);
        transform: translateY(-1px);
      }
      
      .btn:active{
        transform: translateY(0);
      }
      
      .btn.primary{
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        border: none;
        color: white;
        box-shadow: var(--shadow-sm);
      }
      
      .btn.primary:hover{
        background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }
      
      .btn.danger{
        background: var(--surface);
        border-color: var(--danger);
        color: var(--danger);
      }
      
      .btn.danger:hover{
        background: rgba(231, 76, 60, 0.05);
      }
      
      .btn:disabled{
        opacity:0.4;
        cursor:not-allowed;
        transform: none !important;
      }
      
      .btn:disabled:hover{
        background: var(--surface);
      }
      
      .sep{
        width:1px;
        height:24px;
        background:var(--border);
        margin:0 8px;
      }

      /* Panels - más minimalistas */
      .panel{
        background:var(--surface);
        border-radius:var(--radius-lg);
        box-shadow: var(--shadow-md);
        overflow:hidden;
        display:flex;
        flex-direction:column;
        border:1px solid var(--border);
        transition: var(--transition);
      }
      
      .panel:hover{
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
      }
      
      .panel h3{
        margin:0;
        font-size:13px;
        font-weight:600;
        letter-spacing:0.03em;
        color:var(--text-muted);
        padding:14px 16px;
        border-bottom:1px solid var(--border-light);
        text-transform: uppercase;
      }
      
      .panel .content{
        padding:16px;
        overflow:auto;
        min-height:0;
      }

      .left{grid-area:left}
      .right{grid-area:right}

      /* Center stage - más limpio */
      .stage{
        grid-area:center;
        background: linear-gradient(135deg, rgba(245, 247, 250, 0.6) 0%, rgba(255, 255, 255, 0.9) 100%);
        border-radius:var(--radius-lg);
        box-shadow: var(--shadow-lg);
        display:grid;
        grid-template-rows:auto 1fr;
        overflow:hidden;
        border:1px solid var(--border);
        transition: var(--transition);
      }
      
      .stage:hover{
        box-shadow: 0 12px 32px rgba(0,0,0,0.12);
      }

      .stage-toolbar{
        display:flex;
        gap:16px;
        align-items:center;
        padding:14px 18px;
        border-bottom:1px solid var(--border-light);
        background:var(--surface);
      }

      .field{
        display:flex;
        flex-direction:column;
        gap:8px;
        min-width:130px;
      }
      
      .field label{
        font-size:12px;
        font-weight:600;
        color:var(--text-light);
        letter-spacing: 0.02em;
      }
      
      .row{
        display:flex;
        align-items:center;
        gap:12px;
        flex-wrap:wrap;
      }

      input[type="range"]{
        width:160px;
        height:28px;
        -webkit-apearance: none;
        background: var(--surface-alt);
        border-radius: var(--radius-sm);
        outline: none;
      }
      
      input[type="range"]::-webkit-slider-thumb{
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary);
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(67, 97, 238, 0.3);
      }
      
      input[type="range"]::-moz-range-thumb{
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary);
        border: none;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(67, 97, 238, 0.3);
      }

      input[type="color"]{
        width:48px;
        height:40px;
        border:none;
        background:var(--surface);
        border-radius:var(--radius-md);
        padding:0;
        cursor:pointer;
        border:1px solid var(--border);
        transition: var(--transition);
      }
      
      input[type="color"]:hover{
        transform: scale(1.05);
      }

      select, input[type="number"], input[type="text"]{
        background:var(--surface);
        border:1px solid var(--border);
        color:var(--text);
        border-radius:var(--radius-md);
        padding:10px 12px;
        font-size:14px;
        outline:none;
        transition: var(--transition);
        height:40px;
        font-weight: 500;
      }
      
      select:focus, input:focus{
        border-color:var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
      }

      .canvas-wrap{
        position:relative;
        display:flex;
        align-items:center;
        justify-content:center;
        overflow:hidden;
        min-height:0;
        background: var(--surface);
      }

      /* Checkerboard elegante */
      .checker{
        width:100%;
        height:100%;
        background:
          linear-gradient(45deg, rgba(230, 233, 238, 0.3) 25%, transparent 25%),
          linear-gradient(-45deg, rgba(230, 233, 238, 0.3) 25%, transparent 25%),
          linear-gradient(45deg, transparent 75%, rgba(230, 233, 238, 0.3) 75%),
          linear-gradient(-45deg, transparent 75%, rgba(230, 233, 238, 0.3) 75%);
        background-size: 32px 32px;
        background-position: 0 0, 0 16px, 16px -16px, -16px 0px;
        position:absolute;
        inset:0;
        opacity:0.4;
        pointer-events:none;
      }

      canvas{
        border-radius:var(--radius-md);
        background:transparent;
        image-rendering: crisp-edges;
        box-shadow: var(--shadow-md);
        transform-origin: 0 0;
        border:1px solid var(--border-light);
        transition: var(--transition);
      }
      
      canvas:hover{
        box-shadow: var(--shadow-lg);
      }

      /* Tools - más espaciados */
      .toolgrid{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:12px;
      }
      
      .toolbtn{
        width:100%;
        justify-content:center;
        height:48px;
        font-weight: 500;
      }
      
      .toolbtn.active{
        background: linear-gradient(135deg, rgba(67, 97, 238, 0.1) 0%, rgba(67, 97, 238, 0.05) 100%);
        border-color: var(--primary);
        color: var(--primary);
        box-shadow: 0 2px 8px rgba(67, 97, 238, 0.15);
      }

      .hint{
        color:var(--text-light);
        font-size:13px;
        line-height:1.5;
        font-weight: 400;
      }
      
      .kbd{
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size:11px;
        padding:3px 8px;
        border:1px solid var(--border);
        border-radius:var(--radius-sm);
        background:var(--surface-alt);
        color:var(--text);
        font-weight: 500;
        box-shadow: var(--shadow-sm);
      }

      /* Layers - más limpio */
      .layer{
        border-radius:var(--radius-md);
        padding:14px;
        background:var(--surface-alt);
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        border:1px solid var(--border-light);
      }
      
      .layer-name{
        font-size:14px;
        font-weight: 600;
        color: var(--text);
      }
      
      .pill{
        font-size:12px;
        font-weight: 600;
        color:var(--text-muted);
        border:1px solid var(--border);
        padding:5px 12px;
        border-radius:20px;
        background:var(--surface);
        letter-spacing: 0.02em;
      }

      /* Status bar - más sutil */
      .status{
        grid-area:status;
        background:var(--surface);
        border-radius:var(--radius-lg);
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:10px 18px;
        font-size:13px;
        color:var(--text-light);
        box-shadow: var(--shadow-sm);
        border:1px solid var(--border);
      }
      
      .status strong{
        color:var(--text);
        font-weight:600;
      }

      /* Responsive */
      @media (max-width: 1100px){
        body{overflow:auto}
        .app{
          height:auto;
          grid-template-rows: 56px auto auto auto;
          grid-template-columns: 1fr;
          grid-template-areas:
            "top"
            "center"
            "left"
            "right"
            "status";
        }
      }
      
      /* Animaciones suaves */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .panel, .stage, .topbar {
        animation: fadeIn 0.4s ease-out forwards;
      }
      
      .panel:nth-child(1) { animation-delay: 0.1s; }
      .panel:nth-child(2) { animation-delay: 0.2s; }
      .stage { animation-delay: 0.15s; }
      .topbar { animation-delay: 0s; }

      /* Scroll suave */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      
      ::-webkit-scrollbar-track {
        background: var(--surface-alt);
        border-radius: var(--radius-sm);
      }
      
      ::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: var(--radius-sm);
        transition: var(--transition);
      }
      
      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-light);
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Top bar -->
      <div class="topbar">
        <div class="brand">
          <span class="dot"></span>
          <span>Canvas Studio</span>
          <span class="pill" id="docInfo">512×512</span>
        </div>

        <div class="top-actions">
          <button class="btn" id="btnOpen">
            <i class="fa-solid fa-folder-open"></i>
            Open
          </button>
          <button class="btn primary" id="btnSave">
            <i class="fa-solid fa-download"></i>
            Export PNG
          </button>
          <span class="sep"></span>
          <button class="btn" id="btnUndo" disabled>
            <i class="fa-solid fa-rotate-left"></i>
            Undo
          </button>
          <button class="btn" id="btnRedo" disabled>
            <i class="fa-solid fa-rotate-right"></i>
            Redo
          </button>
          <span class="sep"></span>
          <button class="btn danger" id="btnClear">
            <i class="fa-solid fa-trash"></i>
            Clear
          </button>
        </div>
      </div>

      <!-- Left panel: Tools -->
      <div class="panel left">
        <h3><i class="fa-solid fa-brush" style="margin-right:8px;"></i> Tools</h3>
        <div class="content">
          <div class="toolgrid">
            <button class="btn toolbtn active" data-tool="brush">
              <i class="fa-solid fa-paint-brush"></i>
              Brush
            </button>
            <button class="btn toolbtn" data-tool="eraser">
              <i class="fa-solid fa-eraser"></i>
              Eraser
            </button>
            <button class="btn toolbtn" data-tool="line">
              <i class="fa-solid fa-line"></i>
              Line
            </button>
            <button class="btn toolbtn" data-tool="rect">
              <i class="fa-solid fa-square"></i>
              Rectangle
            </button>
          </div>

          <div style="height:20px"></div>

          <div class="hint">
            <i class="fa-solid fa-keyboard" style="margin-right:6px;"></i>
            <strong>Shortcuts:</strong>
            <div style="margin-top:10px; display:grid; gap:8px; padding-left:24px;">
              <div><span class="kbd">B</span> brush, <span class="kbd">E</span> eraser</div>
              <div><span class="kbd">L</span> line, <span class="kbd">R</span> rectangle</div>
              <div><span class="kbd">Ctrl</span>+<span class="kbd">Z</span> undo, <span class="kbd">Ctrl</span>+<span class="kbd">Y</span> redo</div>
              <div><span class="kbd">+</span>/<span class="kbd">-</span> zoom, <span class="kbd">0</span> reset</div>
              <div><span class="kbd">Space</span> hold to pan</div>
            </div>
          </div>

          <div style="height:20px"></div>

          <div class="hint">
            <i class="fa-solid fa-info-circle" style="margin-right:6px;"></i>
            <strong>Notes:</strong>
            <ul style="margin:10px 0 0 24px; padding:0; color:var(--text-light);">
              <li style="margin-bottom:6px;">Line/Rectangle are previewed before committing.</li>
              <li>Eraser uses transparent strokes.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Center stage -->
      <div class="stage">
        <div class="stage-toolbar">
          <div class="field">
            <label><i class="fa-solid fa-palette"></i> Color</label>
            <div class="row">
              <input type="color" id="selectorcolor" value="#4361ee" />
              <input type="text" id="hex" value="#4361ee" style="width:110px" />
            </div>
          </div>

          <div class="field">
            <label><i class="fa-solid fa-ruler"></i> Size</label>
            <div class="row">
              <input type="range" id="grosortrazo" min="1" max="80" value="12" />
              <input type="number" id="sizeNum" min="1" max="200" value="12" style="width:84px" />
            </div>
          </div>

          <div class="field">
            <label><i class="fa-solid fa-adjust"></i> Opacity</label>
            <div class="row">
              <input type="range" id="opacity" min="1" max="100" value="100" />
              <span class="pill" id="opLabel">100%</span>
            </div>
          </div>

          <div class="field">
            <label><i class="fa-solid fa-circle-dot"></i> Hardness</label>
            <div class="row">
              <input type="range" id="hardness" min="0" max="100" value="100" />
              <span class="pill" id="hardLabel">100%</span>
            </div>
          </div>

          <div class="field">
            <label><i class="fa-solid fa-magnifying-glass"></i> Zoom</label>
            <div class="row">
              <button class="btn" id="zoomOut" style="width:42px;">-</button>
              <button class="btn" id="zoomReset" style="width:70px;">100%</button>
              <button class="btn" id="zoomIn" style="width:42px;">+</button>
            </div>
          </div>

          <input type="file" id="fileInput" accept="image/*" hidden />
        </div>

        <div class="canvas-wrap" id="wrap">
          <div class="checker"></div>
          <canvas id="canvas" width="512" height="512"></canvas>
          <canvas id="overlay" width="512" height="512" style="position:absolute; inset:auto; pointer-events:none;"></canvas>
        </div>
      </div>

      <!-- Right panel: Layers / Document -->
      <div class="panel right">
        <h3><i class="fa-solid fa-file-lines" style="margin-right:8px;"></i> Document</h3>
        <div class="content">
          <div class="layer">
            <div>
              <div class="layer-name">Layer 1</div>
              <div class="hint" style="margin-top:6px">
                <i class="fa-solid fa-layer-group" style="margin-right:6px;"></i>
                Single-layer editor
              </div>
            </div>
            <span class="pill" id="zoomPill">100%</span>
          </div>

          <div style="height:20px"></div>

          <div class="field">
            <label><i class="fa-solid fa-expand"></i> Canvas Size</label>
            <div class="row">
              <input type="number" id="w" value="512" min="16" max="4096" style="width:100px" placeholder="Width" />
              <span style="color:var(--text-light); font-size:16px;">×</span>
              <input type="number" id="h" value="512" min="16" max="4096" style="width:100px" placeholder="Height" />
              <button class="btn" id="btnResize" style="padding:10px 14px;">
                <i class="fa-solid fa-arrows-up-down-left-right"></i>
              </button>
            </div>
            <div class="hint" style="margin-top:10px; font-size:12px;">
              <i class="fa-solid fa-triangle-exclamation" style="margin-right:6px;"></i>
              Resize clears the canvas. Extend to preserve content.
            </div>
          </div>

          <div style="height:20px"></div>

          <div class="field">
            <label><i class="fa-solid fa-palette"></i> Background</label>
            <div class="row">
              <select id="bgMode" style="flex:1; min-width:140px;">
                <option value="transparent" selected>TransparentColor</option>
                <option value="white">White</option>
                <option value="black">Black</option>
              </select>
              <button class="btn" id="btnFillBG" style="padding:10px 16px;">
                <i class="fa-solid fa-fill-drip"></i>
                Apply
              </button>
            </div>
            <div class="hint" style="margin-top:10px; font-size:12px;">
              <i class="fa-solid fa-circle-info" style="margin-right:6px;"></i>
              Background fill is drawn onto the canvas (destructive).
            </div>
          </div>
        </div>
      </div>

      <!-- Status bar -->
      <div class="status">
        <div>
          <i class="fa-solid fa-toolbox" style="margin-right:8px; color:var(--primary);"></i>
          Tool: <strong id="statusTool">Brush</strong> ·
          <i class="fa-solid fa-location-crosshairs" style="margin:0 8px 0 12px; color:var(--text-light);"></i>
          Pointer: <strong id="statusXY">—</strong>
        </div>
        <div>
          <i class="fa-solid fa-arrows-up-down-left-right" style="margin-right:8px; color:var(--warning);"></i>
          Pan: <strong id="statusPan">0, 0</strong> ·
          <i class="fa-solid fa-magnifying-glass" style="margin:0 8px 0 12px; color:var(--success);"></i>
          Zoom: <strong id="statusZoom">100%</strong>
        </div>
      </div>
    </div>

    <!-- Script igual al original, solo cambio el color inicial -->
    <script>
      // ====== Canvas setup ======
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });
      const overlay = document.getElementById("overlay");
      const octx = overlay.getContext("2d");

      const wrap = document.getElementById("wrap");

      // Inputs
      const colorInput = document.getElementById("selectorcolor");
      const hexInput = document.getElementById("hex");
      const sizeRange = document.getElementById("grosortrazo");
      const sizeNum = document.getElementById("sizeNum");
      const opacity = document.getElementById("opacity");
      const opLabel = document.getElementById("opLabel");
      const hardness = document.getElementById("hardness");
      const hardLabel = document.getElementById("hardLabel");

      // Top actions
      const btnOpen = document.getElementById("btnOpen");
      const btnSave = document.getElementById("btnSave");
      const btnUndo = document.getElementById("btnUndo");
      const btnRedo = document.getElementById("btnRedo");
      const btnClear = document.getElementById("btnClear");

      const fileInput = document.getElementById("fileInput");

      // Resize
      const wInput = document.getElementById("w");
      const hInput = document.getElementById("h");
      const btnResize = document.getElementById("btnResize");
      const docInfo = document.getElementById("docInfo");

      // Background
      const bgMode = document.getElementById("bgMode");
      const btnFillBG = document.getElementById("btnFillBG");

      // Zoom / pan
      const zoomIn = document.getElementById("zoomIn");
      const zoomOut = document.getElementById("zoomOut");
      const zoomReset = document.getElementById("zoomReset");
      const zoomPill = document.getElementById("zoomPill");

      // Status
      const statusTool = document.getElementById("statusTool");
      const statusXY = document.getElementById("statusXY");
      const statusPan = document.getElementById("statusPan");
      const statusZoom = document.getElementById("statusZoom");

      // Tool buttons
      const toolButtons = Array.from(document.querySelectorAll(".toolbtn"));

      // State
      let tool = "brush"; // brush | eraser | line | rect
      let drawing = false;
      let spacePanning = false;

      let startX = 0, startY = 0;  // for shapes
      let lastX = 0, lastY = 0;    // for brush/eraser

      let zoom = 1;
      let panX = 0, panY = 0;      // in CSS pixels
      let panStart = { x: 0, y: 0 };
      let pointerStart = { x: 0, y: 0 };

      // History
      const undoStack = [];
      const redoStack = [];
      const HISTORY_LIMIT = 40;

      function pushHistory() {
        try {
          const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
          undoStack.push(img);
          if (undoStack.length > HISTORY_LIMIT) undoStack.shift();
          redoStack.length = 0;
          updateHistoryButtons();
        } catch (e) {
          console.warn("History snapshot failed:", e);
        }
      }

      function updateHistoryButtons() {
        btnUndo.disabled = undoStack.length === 0;
        btnRedo.disabled = redoStack.length === 0;
      }

      function setTool(next) {
        tool = next;
        toolButtons.forEach(b => b.classList.toggle("active", b.dataset.tool === next));
        statusTool.textContent = next.charAt(0).toUpperCase() + next.slice(1);
      }

      function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

      function setZoom(nextZoom, anchorClientX = null, anchorClientY = null) {
        const prev = zoom;
        zoom = clamp(nextZoom, 0.2, 6);

        if (anchorClientX != null && anchorClientY != null) {
          const rect = wrap.getBoundingClientRect();
          const ax = anchorClientX - rect.left;
          const ay = anchorClientY - rect.top;

          const worldX = (ax - panX) / prev;
          const worldY = (ay - panY) / prev;

          panX = ax - worldX * zoom;
          panY = ay - worldY * zoom;
        }

        applyTransform();
      }

      function applyTransform() {
        canvas.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`;
        overlay.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`;

        const zPct = Math.round(zoom * 100);
        zoomReset.textContent = `${zPct}%`;
        zoomPill.textContent = `${zPct}%`;
        statusZoom.textContent = `${zPct}%`;
        statusPan.textContent = `${Math.round(panX)}, ${Math.round(panY)}`;
      }

      // ====== Brush rendering (supports hardness) ======
      function drawDot(x, y, radius, rgba, hardPct) {
        const hard = clamp(hardPct / 100, 0, 1);
        const grd = ctx.createRadialGradient(x, y, 0, x, y, radius);
        grd.addColorStop(0, rgba);
        grd.addColorStop(hard, rgba);
        const transparent = rgba.replace(/rgba\(([^)]+)\)/, (m, inner) => {
          const parts = inner.split(",").map(s => s.trim());
          return `rgba(${parts[0]}, ${parts[1]}, ${parts[2]}, 0)`;
        });
        grd.addColorStop(1, transparent);

        ctx.fillStyle = grd;
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.fill();
      }

      function hexToRgb(hex) {
        const h = hex.replace("#", "").trim();
        const full = h.length === 3 ? h.split("").map(c => c + c).join("") : h;
        const int = parseInt(full, 16);
        const r = (int >> 16) & 255;
        const g = (int >> 8) & 255;
        const b = int & 255;
        return { r, g, b };
      }

      function rgbaFromUI(alphaOverride = null) {
        const { r, g, b } = hexToRgb(colorInput.value);
        const a = alphaOverride != null ? alphaOverride : (opacity.value / 100);
        return `rgba(${r}, ${g}, ${b}, ${a})`;
      }

      function clearOverlay() {
        octx.clearRect(0, 0, overlay.width, overlay.height);
      }

      function drawOverlayPreview(fn) {
        clearOverlay();
        octx.save();
        octx.imageSmoothingEnabled = true;
        fn(octx);
        octx.restore();
      }

      function commitOverlay() {
        ctx.drawImage(overlay, 0, 0);
        clearOverlay();
      }

      function toCanvasXY(clientX, clientY) {
        const rect = wrap.getBoundingClientRect();
        const x = (clientX - rect.left - panX) / zoom;
        const y = (clientY - rect.top - panY) / zoom;
        return { x, y };
      }

      function updatePointerStatus(clientX, clientY) {
        const p = toCanvasXY(clientX, clientY);
        if (p.x < 0 || p.y < 0 || p.x > canvas.width || p.y > canvas.height) {
          statusXY.textContent = "—";
        } else {
          statusXY.textContent = `${Math.round(p.x)}, ${Math.round(p.y)}`;
        }
      }

      // ====== Events ======
      function onPointerDown(e) {
        if (spacePanning) {
          drawing = true;
          panStart = { x: panX, y: panY };
          pointerStart = { x: e.clientX, y: e.clientY };
          return;
        }

        const p = toCanvasXY(e.clientX, e.clientY);
        if (p.x < 0 || p.y < 0 || p.x > canvas.width || p.y > canvas.height) return;

        pushHistory();

        drawing = true;
        startX = p.x; startY = p.y;
        lastX = p.x;  lastY = p.y;

        if (tool === "brush") {
          ctx.globalCompositeOperation = "source-over";
          drawDot(p.x, p.y, Number(sizeRange.value), rgbaFromUI(), Number(hardness.value));
        } else if (tool === "eraser") {
          ctx.globalCompositeOperation = "destination-out";
          drawDot(p.x, p.y, Number(sizeRange.value), rgbaFromUI(1), Number(hardness.value));
          ctx.globalCompositeOperation = "source-over";
        } else {
          clearOverlay();
        }
      }

      function onPointerMove(e) {
        updatePointerStatus(e.clientX, e.clientY);

        if (!drawing) return;

        if (spacePanning) {
          const dx = e.clientX - pointerStart.x;
          const dy = e.clientY - pointerStart.y;
          panX = panStart.x + dx;
          panY = panStart.y + dy;
          applyTransform();
          return;
        }

        const p = toCanvasXY(e.clientX, e.clientY);
        if (tool === "brush" || tool === "eraser") {
          const r = Number(sizeRange.value);
          const steps = Math.max(1, Math.ceil(Math.hypot(p.x - lastX, p.y - lastY) / (r * 0.5)));
          for (let i = 1; i <= steps; i++) {
            const t = i / steps;
            const x = lastX + (p.x - lastX) * t;
            const y = lastY + (p.y - lastY) * t;
            if (tool === "brush") {
              ctx.globalCompositeOperation = "source-over";
              drawDot(x, y, r, rgbaFromUI(), Number(hardness.value));
            } else {
              ctx.globalCompositeOperation = "destination-out";
              drawDot(x, y, r, rgbaFromUI(1), Number(hardness.value));
              ctx.globalCompositeOperation = "source-over";
            }
          }
          lastX = p.x; lastY = p.y;
        } else if (tool === "line") {
          const stroke = rgbaFromUI();
          const w = Math.max(1, Number(sizeRange.value) * 2);
          drawOverlayPreview((g) => {
            g.lineCap = "round";
            g.lineJoin = "round";
            g.strokeStyle = stroke;
            g.globalAlpha = 1;
            g.lineWidth = w;
            g.beginPath();
            g.moveTo(startX, startY);
            g.lineTo(p.x, p.y);
            g.stroke();
          });
        } else if (tool === "rect") {
          const stroke = rgbaFromUI();
          const w = Math.max(1, Number(sizeRange.value) * 2);
          drawOverlayPreview((g) => {
            g.strokeStyle = stroke;
            g.lineWidth = w;
            const x = Math.min(startX, p.x);
            const y = Math.min(startY, p.y);
            const ww = Math.abs(p.x - startX);
            const hh = Math.abs(p.y - startY);
            g.strokeRect(x, y, ww, hh);
          });
        }
      }

      function onPointerUp(e) {
        if (!drawing) return;
        drawing = false;

        if (spacePanning) return;

        if (tool === "line" || tool === "rect") {
          commitOverlay();
        }
      }

      // ====== UI wiring ======
      toolButtons.forEach(btn => {
        btn.addEventListener("click", () => setTool(btn.dataset.tool));
      });

      function syncSizeInputs(from) {
        const v = clamp(Number(from.value || from), 1, 200);
        sizeRange.value = v;
        sizeNum.value = v;
      }
      sizeRange.addEventListener("input", () => syncSizeInputs(sizeRange));
      sizeNum.addEventListener("input", () => syncSizeInputs(sizeNum));

      function syncColorInputs(from) {
        let v = from.value.trim();
        if (!v.startsWith("#")) v = "#" + v;
        if (!/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v)) return;
        colorInput.value = v;
        hexInput.value = v.toLowerCase();
      }
      colorInput.addEventListener("input", () => syncColorInputs(colorInput));
      hexInput.addEventListener("input", () => syncColorInputs(hexInput));

      function syncOpacity() {
        opLabel.textContent = `${opacity.value}%`;
      }
      opacity.addEventListener("input", syncOpacity);
      syncOpacity();

      function syncHardness() {
        hardLabel.textContent = `${hardness.value}%`;
      }
      hardness.addEventListener("input", syncHardness);
      syncHardness();

      // Open image
      btnOpen.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;

        const img = new Image();
        img.onload = () => {
          pushHistory();
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
          const w = img.width * scale;
          const h = img.height * scale;
          const x = (canvas.width - w) / 2;
          const y = (canvas.height - h) / 2;
          ctx.drawImage(img, x, y, w, h);
        };
        img.src = URL.createObjectURL(file);
        fileInput.value = "";
      });

      // Save PNG
      btnSave.addEventListener("click", () => {
        const a = document.createElement("a");
        a.download = `export-${Date.now()}.png`;
        a.href = canvas.toDataURL("image/png");
        a.click();
      });

      // Clear
      btnClear.addEventListener("click", () => {
        pushHistory();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });

      // Undo/Redo
      function undo() {
        if (undoStack.length === 0) return;
        const current = ctx.getImageData(0, 0, canvas.width, canvas.height);
        redoStack.push(current);
        const prev = undoStack.pop();
        ctx.putImageData(prev, 0, 0);
        clearOverlay();
        updateHistoryButtons();
      }
      function redo() {
        if (redoStack.length === 0) return;
        const current = ctx.getImageData(0, 0, canvas.width, canvas.height);
        undoStack.push(current);
        const next = redoStack.pop();
        ctx.putImageData(next, 0, 0);
        clearOverlay();
        updateHistoryButtons();
      }
      btnUndo.addEventListener("click", undo);
      btnRedo.addEventListener("click", redo);

      // Resize (simple: clears content)
      btnResize.addEventListener("click", () => {
        const w = clamp(Number(wInput.value), 16, 4096);
        const h = clamp(Number(hInput.value), 16, 4096);

        canvas.width = w; canvas.height = h;
        overlay.width = w; overlay.height = h;

        docInfo.textContent = `${w}×${h}`;
        ctx.clearRect(0, 0, w, h);
        clearOverlay();

        undoStack.length = 0;
        redoStack.length = 0;
        updateHistoryButtons();
      });

      // Background fill (destructive)
      btnFillBG.addEventListener("click", () => {
        pushHistory();
        const mode = bgMode.value;
        if (mode === "transparent") {
          return;
        }
        const fill = (mode === "white") ? "#ffffff" : "#000000";
        const snap = ctx.getImageData(0, 0, canvas.width, canvas.height);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = fill;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.putImageData(snap, 0, 0);
      });

      // Zoom buttons
      zoomIn.addEventListener("click", () => setZoom(zoom * 1.15));
      zoomOut.addEventListener("click", () => setZoom(zoom / 1.15));
      zoomReset.addEventListener("click", () => { zoom = 1; panX = 0; panY = 0; applyTransform(); });

      // Wheel zoom on stage (Ctrl not required)
      wrap.addEventListener("wheel", (e) => {
        e.preventDefault();
        const factor = e.deltaY < 0 ? 1.08 : (1 / 1.08);
        setZoom(zoom * factor, e.clientX, e.clientY);
      }, { passive:false });

      // Pointer events
      wrap.addEventListener("pointerdown", (e) => {
        wrap.setPointerCapture(e.pointerId);
        onPointerDown(e);
      });
      wrap.addEventListener("pointermove", onPointerMove);
      wrap.addEventListener("pointerup", (e) => {
        onPointerUp(e);
        try { wrap.releasePointerCapture(e.pointerId); } catch {}
      });

      // Space to pan
      window.addEventListener("keydown", (e) => {
        if (e.key === " " && !e.repeat) spacePanning = true;

        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "z") { e.preventDefault(); undo(); }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "y") { e.preventDefault(); redo(); }

        const k = e.key.toLowerCase();
        if (k === "b") setTool("brush");
        if (k === "e") setTool("eraser");
        if (k === "l") setTool("line");
        if (k === "r") setTool("rect");

        if (e.key === "+") setZoom(zoom * 1.15);
        if (e.key === "-") setZoom(zoom / 1.15);
        if (e.key === "0") { zoom = 1; panX = 0; panY = 0; applyTransform(); }
      });

      window.addEventListener("keyup", (e) => {
        if (e.key === " ") spacePanning = false;
      });

      // Initial view
      setTool("brush");
      applyTransform();
      updateHistoryButtons();
      docInfo.textContent = `${canvas.width}×${canvas.height}`;

      // Make overlay match canvas size & crisp
      function syncOverlay() {
        overlay.width = canvas.width;
        overlay.height = canvas.height;
      }
      syncOverlay();
    </script>
  </body>
</html>